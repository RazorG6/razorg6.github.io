/*! Copyright (c) Epic Systems Corporation 2018 */
(function WP$UI$SubwayWorkflowController$definition(){var m=".line",q="swing",h=".stops",w=".scrollright",D=".scrollleft",d="left",C=".stops, .line",B=".scrollleft, .scrollright",A="scrollable",l="toRemove",z=".trainrail:nth-child(",v=".trainstop:nth-child(",u="noFade",t=".nav",i=".subway",y="stepClicked",k=".trainstop",p="#subway-submit",o="#subway-next",s="#subway-back",r="tabindex",n="@MYCHART@TOTALNUMBEROFSTEPS@",e="UI.Subway",x="#subwayWarning",c=true,a=false,b=null,f="undefined",g="click",E=function WP$UI$SubwayStop$SubwayNavigationViewBinder(){this.WP$Common$ViewBinder([g],["Status"])},j=$$WP.UI.SubwayStop,F=function WP$UI$SubwayWorkflowController(e,d,c){var a=this;a.WP$Controllers$Controller();a.$root=e;a._viewBinder=new E;a.CanCancel=!($$WP.Utilities.UI.IsMobile&&$$WP.Utilities.UI.IsLoggedIn);if(c){if(c.formNavAlignment)a._formNavAlignment=c.formNavAlignment;if(c.useCompact)a._useCompact=c.useCompact;if(c.setFocusToStep)a._setFocusToStep=c.setFocusToStep;if(c.showThisStepOnRender>0)a._showThisStepOnRender=c.showThisStepOnRender;if(a._useCompact){a._scrollableThreshold=7;if($$WP.Utilities.UI.Prelogin)a._scrollableThreshold=6}if(typeof c.DrawNavButtons!==f)a._drawNavButtons=c.DrawNavButtons;if(typeof c.AllowBackNavWhenInvalid!==f)a.AllowBackNavWhenInvalid=c.AllowBackNavWhenInvalid;if(typeof c.CanFinishLater!==f)a.CanFinishLater=c.CanFinishLater;if(typeof c.CanCancel!==f)a.CanCancel=c.CanCancel;if(typeof c.verifyCheckboxWithValidation!==f)a._verifyCheckboxWithValidation=c.verifyCheckboxWithValidation}a.Data=j.createModelCollection();typeof d!==f&&d!==b&&j.convertRawStops(d,a.Data);a._subwayStopControllers=[];a._noDataTemplate=function WP$UI$SubwayWorkflowController$_noDataTemplate(){return"<div class='nodata'>"+$$WP.Strings.get("NoDataText","Global")+"</div>"};a.proxify("_showPrevStep","_showNextStep","_cancelFunction","_submitFunction","_onFinishLater","_finishLaterDeactivateComplete","_finishLater","_onDeactivateComplete","_onActivateComplete","_onStepChange","_onBrowserResize","_onStopFocus","_moveSubwayLeft","_moveSubwayRight","_pauseSubway","_resetSubwayPosition","_makeStopViewable","_setSubwayLineAnimation","isCurrentStopTheLastStop","isCurrentStopTheFirstStop");a.$root.on("submit",b,a._showNextStep)},H={$root:b,$subway:b,$subwayStep:b,$subwayNav:b,$workflowNavButtons:b,Data:b,AllowBackNavWhenInvalid:b,CanFinishLater:a,CanCancel:c,_subwayStopControllers:b,_viewBinder:b,_noDataTemplate:b,_noDataContext:b,_firstStepLoad:c,_deactivateResult:a,_canModifyStepList:c,_scrollableStopsLeftBound:0,_scrollableLineLeftBound:0,_scrollableStopsRightBound:0,_scrollableLineRightBound:0,_formNavAlignment:0,_useCompact:a,_scrollableThreshold:6,_setFocusToStep:a,_showThisStepOnRender:0,_currentStep:-1,_newStep:-1,_drawNavButtons:c,_verifyCheckboxWithValidation:a,_showStep:function WP$UI$SubwayWorkflowController$_showStep(e,d,f){var b=this;$afe.select(x).hide();if(!d&&!$$WP.FormValidation.checkIfFormIsValid(b.$root,c))return a;b._newStep=e;b._deactivateResult=a;if(b._subwayStopControllers[b._currentStep])b._subwayStopControllers[b._currentStep].deactivateStep(b.Data.Models[b._currentStep],b._onDeactivateComplete,b._newStep>b._currentStep,f);else b._onDeactivateComplete(c);return b._deactivateResult},deactivateCurrentStep:function WP$UI$SubwayWorkflowController$deactivateCurrentStep(){var a=this;if(a._subwayStopControllers[a._currentStep])a._subwayStopControllers[a._currentStep].deactivateStep(a.Data.Models[a._currentStep],a._onDeactivateComplete,c);else a._onDeactivateComplete(c)},_onDeactivateComplete:function WP$UI$SubwayWorkflowController$_onDeactivateComplete(d){var b=this;b._deactivateResult=d;if(!d){b._newStep=-1;return}b._canModifyStepList=c;b._onStepChange(b._currentStep,b._newStep);b._canModifyStepList=a;b._subwayStopControllers[b._newStep]&&b._subwayStopControllers[b._newStep].activateStep(b.Data.Models[b._newStep],b._onActivateComplete)},_onActivateComplete:function WP$UI$SubwayWorkflowController$_onActivateComplete(w){var l=".messagedisplay",d="hidden",k="#subway-verify-container",j="previousstep",i="@MYCHART@CURRENTSTEPNUMBER@",b=this,h,t,g=b.$workflowNavButtons;if(!w){b._newStep=-1;return}if(b._subwayStopControllers[b._newStep]){b._subwayStopControllers[b._newStep].renderStep();if(!b._firstStepLoad){var m=$afe.select("#subwayStepFocusTarget");$$WP.Strings.addMnemonic(i,b._newStep+1,a,e);$$WP.Strings.addMnemonic(n,b._subwayStopControllers.length,a,e);$$WP.Strings.setDisplayText(m,"StepNumberIndicator",e);$$WP.Strings.removeMnemonic(i);$$WP.Strings.removeMnemonic(n);m.focus();var q=typeof b.dataPool===f,v=q||typeof b.dataPool.EmbeddedWorkflowSettings===f;if(q||v)$$WPUtil.setScrollTop(0);else if($$WP.Utilities.UI.IsMobile)if($$WP.Utilities.UI.IsSmallScreen())$$WPUtil.SmoothScrollToElementWithOffset($$WPUtil.ScrollableBody(),$afe.select("a[name='maintop']"),6,300);else $$WPUtil.SmoothScrollToElement($$WPUtil.ScrollableBody(),$afe.select("#main"),300)}else b._firstStepLoad=a;if(b._setFocusToStep){var u=WP.Utils.iterateFindNext(WP.DOM.Search.getPrevious,function(b){var a=$afe.jq(b).safeAttr(r);if(a){if(parseInt(a)>=0)return c}else return WP.DOM.Test.canFocus(b)},b.$subwayStep[0]);u.focus();u.blur()}h=g.find(s);if(b._newStep===0){h.hide();h.removeClass(j)}else{h.show();h.addClass(j)}if(b._newStep===b._subwayStopControllers.length-1){g.find(o).hide();g.find(p).show()}else{g.find(o).show();g.find(p).hide()}if(b._subwayStopControllers[b._newStep].ShowVerifyCheckbox){g.find(k).removeClass(d);g.find(l).removeClass(d)}else{g.find(k).addClass(d);g.find(l).addClass(d)}}$afe.select("#subway-verify-warning").addClass(d);t=b._newStep>b._currentStep;b._currentStep=b._newStep;b._newStep=-1;!b._subwayStopControllers[b._currentStep].SkipValidation&&$$WP.FormValidation.initializeDOMSubtree(b.$root,!t);b._isScrollable()&&b._makeStopViewable(b._currentStep);matchWrapHeight()},_onBrowserResize:function WP$UI$SubwayWorkflowController$_onBrowserResize(){if(this._isScrollable()){this._calculateScrollBounds();this._resetSubwayPosition()}},_onStopFocus:function WP$UI$SubwayWorkflowController$_onStopFocus(b){var a;a=$afe.select(k).index(b.currentTarget);this._makeStopViewable(a)},_onStepChange:function WP$UI$SubwayWorkflowController$_onStepChange(){},_showNextStep:function WP$UI$SubwayWorkflowController$_showNextStep(b){var a=this;if(a._currentStep+1<a._subwayStopControllers.length){a._showStep(a._currentStep+1,a._subwayStopControllers[a._currentStep].SkipValidation,b);if(b){b.stopPropagation();b.preventDefault()}}},_showPrevStep:function WP$UI$SubwayWorkflowController$_showPrevStep(b){var a=this;if(a._currentStep>0){a._showStep(a._currentStep-1,a.AllowBackNavWhenInvalid||a._subwayStopControllers[a._currentStep].SkipValidation,b);if(b){b.stopPropagation();b.preventDefault()}}},render:function WP$UI$SubwayWorkflowController$render(){var h="#subway-finish-later",f="#subway-cancel",l="@MYCHART@LASTVISIBLESTEP@",j="@MYCHART@FIRSTHIDDENSTEP@",b=this;if(b._subwayStopControllers.length===0||b._hasNoData())b.$root.empty().safeAppend($afe.renderTemplate(b._noDataTemplate,b._noDataContext));else{var d,m;b._canModifyStepList=a;Handlebars.registerPartial("SubwayStop",$$WP.Templates.UI.SubwayStop);Handlebars.registerPartial("SubwayLine",$$WP.Templates.UI.SubwayLine);$$WP.Strings.addMnemonic(n,b._subwayStopControllers.length,a,e);$$WP.Strings.addMnemonic(j,b._scrollableThreshold,a,e);$$WP.Strings.addMnemonic(l,b._scrollableThreshold-1,a,e);b.$root.empty().safeAppend($afe.renderTemplate($$WP.Templates.UI.Subway,{CanCancel:b.CanCancel,SubwayStops:b.Data.Models,ViewBinderId:b._viewBinder.ViewBinderId,NavButtonAlignment:b._formNavAlignment,DrawNavButtons:b._drawNavButtons,VerifyCheckboxWithValidation:b._verifyCheckboxWithValidation}));$$WP.Strings.removeMnemonic(n);$$WP.Strings.removeMnemonic(j);$$WP.Strings.removeMnemonic(l);b.$subwayStep=b.$root.children(".subwayStep");b._setSubwayLineAnimation();if(b._drawNavButtons)b.$workflowNavButtons=b.$root.children(".formbuttons");else b.$workflowNavButtons=$afe.jq();var c=b.$workflowNavButtons;for(d=0;d<b._subwayStopControllers.length;d++)b._subwayStopControllers[d].bindSubwayStep(b.$subwayStep);b._viewBinder.setBindingRoot(b.$subway);b._viewBinder.bindAllModels(b.Data.Models);b.$subway.on(y,$.proxy(function(j,d){var a=this,h=a.AllowBackNavWhenInvalid&&d<a._currentStep,f=a._showStep(d,h||a._subwayStopControllers[a._currentStep].SkipValidation,j),g=$afe.select(i);if(!f&&g.length>0){var c=$afe.select(x);if(c.length>0)c.show();else{var b={};b.id="subwayWarning";$$WP.Strings.setDefaultNamespace(e);g.safeAfter($$WP.SimpleTemplates.ValidationMessage($$WP.Strings.get("RequiredFieldsWarning"),b));$$WP.Strings.clearDefaultNamespace()}}return f},b));c.on(g,f,b._cancelFunction);c.on(g,s,b._showPrevStep);c.on(g,o,b._showNextStep);c.on(g,p,b._submitFunction);c.on(g,h,b._onFinishLater);if(b.CanCancel)c.find(f).show();else c.find(f).hide();c.find(s).hide();c.find(o).show();c.find(p).hide();if(b.CanFinishLater)c.find(h).show();else c.find(h).hide();m=$afe.select(k);for(d=0;d<m.length;++d)$afe.jq(m[d]).on("focusin",b._onStopFocus);b._attachInsertRemoveAnimationListeners();b._showStep(b._showThisStepOnRender);WP.Events.beforeUnload()}},_setSubwayLineAnimation:function WP$UI$SubwayWorkflowController$setSubwayLineAnimation(){var a=this;a.$subway=a.$root.children(i);a.$subwayNav=a.$subway.children(t);if(a._isScrollable())a._prepareScrollableSubway(c);else a.$subway.addClass(u);$afe.jq(window).on("resize",a._onBrowserResize)},addStop:function WP$UI$SubwayWorkflowController$addStop(a){return this._subwayStopControllers.push(a)},insertStop:function WP$UI$SubwayWorkflowController$insertStop(e,h,d){var a=this;if(!a._canModifyStepList||d<1)return;var g,f;if(d>=a.Data.Models.length){d=a.Data.Models.length;e.Index=a.Data.Models[d-1].Index+1}else e.Index=(a.Data.Models[d-1].Index+a.Data.Models[d].Index)/2;a._subwayStopControllers.splice(d,0,h);$$WP.UI.SubwayStop.convertRawStops([e],a.Data);a.Data.sortByIndex("Index");a._subwayStopControllers[d].bindSubwayStep(a.$subwayStep);a._viewBinder.bindAllModels(a.Data.Models);a.Data.Models[d].AnimateIn=c;g=$afe.renderTemplate($$WP.Templates.UI.SubwayStop,{SubwayStops:[a.Data.Models[d]],ViewBinderId:a._viewBinder.ViewBinderId});f=$afe.renderTemplate($$WP.Templates.UI.SubwayLine,{SubwayStops:[b,a.Data.Models[d]]});delete a.Data.Models[d].AnimateIn;$afe.select(v+d+")").safeAfter(g);$afe.select(z+(d-1)+")").safeAfter(f);$afe.select(v+(d+1)+")").on("focusin",a._onStopFocus);a._isScrollable()&&a._prepareScrollableSubway(a.Data.size()===a._scrollableThreshold+1);WP.DOM.Browser.isIE&&a._onBrowserResize()},removeStop:function WP$UI$SubwayWorkflowController$removeStop(b){var a=this;if(!a._canModifyStepList||b<0||b>=a.Data.Models.length)return;var c;c=a.Data.Models[b];a._subwayStopControllers.splice(b,1);$$WP.UI.SubwayStop.removeStop(c,a.Data);a._viewBinder.unbindModel(c);$afe.select(v+(b+1)+")").addClass(l);$afe.select(z+b+")").addClass(l);if(a._isScrollable())a._calculateScrollBounds();else if(a.Data.size()===a._scrollableThreshold){a.$subway.addClass(u);a.$subway.removeClass(A);$afe.select(B).unbind(g);$afe.select(C).css(d,"")}WP.DOM.Browser.isIE&&a._onBrowserResize()},setNoDataTemplate:function(b,c){var a=this;a._noDataTemplate=b||a._noDataTemplate;a._noDataContext=c||a._noDataContext},_isScrollable:function WP$UI$SubwayWorkflowController$_isScrollable(){return!$$WP.Utilities.UI.IsMobile&&this.Data.size()>this._scrollableThreshold},_prepareScrollableSubway:function WP$UI$SubwayWorkflowController$_prepareScrollableSubway(b){var a=this;a.$subway.removeClass(u);a.$subway.addClass(A);a._calculateScrollBounds();if(b){$afe.select(D).click(a._moveSubwayLeft);$afe.select(w).click(a._moveSubwayRight);$afe.select(B).keypress(a,function(a){if(a.keyCode===32){this.click();a.preventDefault()}});a._newStep<a._scrollableThreshold&&a._resetSubwayPosition()}},_calculateScrollBounds:function WP$UI$SubwayWorkflowController$_calculateScrollBounds(){var a=this,f,g,d,b=$afe.select(k).outerWidth(),e=$afe.select(D).outerWidth(),c=0;if(WP.DOM.Browser.isIE&&a.Data.size()===a._scrollableThreshold+1)c=e;a._scrollableStopsLeftBound=e;a._scrollableLineLeftBound=a._scrollableStopsLeftBound+b/2-c;f=a.Data.Models.length*b;g=$afe.select(t).outerWidth();d=$afe.select(w).outerWidth();a._scrollableStopsRightBound=(f-(g-d))*-1;a._scrollableLineRightBound=a._scrollableStopsRightBound+b/2-c},_moveSubwayLeft:function WP$UI$SubwayWorkflowController$_moveSubwayLeft(){var a;a=Math.abs(parseInt($afe.select(h).css(d))-this._scrollableStopsLeftBound);$afe.select(h).animate({left:this._scrollableStopsLeftBound},a,q);$afe.select(m).animate({left:this._scrollableLineLeftBound},a,q)},_moveSubwayRight:function WP$UI$SubwayWorkflowController$_moveSubwayRight(){var a;a=parseInt($afe.select(h).css(d))-this._scrollableStopsRightBound;$afe.select(h).animate({left:this._scrollableStopsRightBound},a,q);$afe.select(m).animate({left:this._scrollableLineRightBound},a,q)},_pauseSubway:function WP$UI$SubwayWorkflowController$_pauseSubway(){$afe.select(C).stop()},_resetSubwayPosition:function WP$UI$SubwayWorkflowController$_resetSubwayPosition(){$afe.select(h).css(d,this._scrollableStopsLeftBound);$afe.select(m).css(d,this._scrollableLineLeftBound)},_attachInsertRemoveAnimationListeners:function WP$UI$SubwayWorkflowController$_attachInsertRemoveAnimationListeners(){this.$subway.on("animationstart",k,function(){var a="margin-left",b,c;b=$afe.jq(this);c=parseInt(b.css("width"));if(b.hasClass("toAdd"))b.css(a,-1*c).animate({"margin-left":0},300);else b.hasClass(l)&&b.css(a,0).animate({"margin-left":-1*c},300)});this.$subway.on("animationend",".trainstop, .trainrail",function(){var a;a=$afe.jq(this);a.hasClass(l)&&a.remove();a.removeClass("toAdd")})},_makeStopViewable:function WP$UI$SubwayWorkflowController$_makeStopViewable(i){if(!this._isScrollable())return;var f,e,g,b,c,a;f=$afe.select(k).outerWidth();e=parseInt($afe.select(h).css(d));g=parseInt($afe.select(m).css(d));b=e+i*f;c=$afe.select(t).outerWidth()-$afe.select(w).outerWidth()-f;a=0;if(b<this._scrollableStopsLeftBound)a=this._scrollableStopsLeftBound-b;else if(b>c)a=c-b;if(a!==0){$afe.select(h).css(d,e+a);$afe.select(m).css(d,g+a)}},_hasNoData:function WP$UI$SubwayWorkflowController$_hasNoData(){throw"[SubwayWorkflowController] subclass failed to override virtual method _hasNoData.";},_submitFunction:function WP$UI$SubwayWorkflowController$_submitFunction(){throw"[SubwayWorkflowController] subclass failed to override virtual method _submitFunction.";},_cancelFunction:function WP$UI$SubwayWorkflowController$_cancelFunction(){throw"[SubwayWorkflowController] subclass allows cancel yet failed to override virtual method _cancelFunction.";},_onFinishLater:function WP$UI$SubwayWorkflowController$_onFinishLater(d){var b=this;b._deactivateResult=a;if(b._subwayStopControllers[b._currentStep])b._subwayStopControllers[b._currentStep].deactivateStep(b.Data.Models[b._currentStep],b._finishLaterDeactivateComplete,a,d);else b._onDeactivateComplete(c);return b._deactivateResult},_finishLaterDeactivateComplete:function WP$UI$SubwayWorkflowController$_finishLaterDeactivateComplete(a){this._deactivateResult=a;if(!a)return;this._finishLater()},_finishLater:function WP$UI$SubwayWorkflowController$_finishLater(){throw"[SubwayWorkflowController] subclass allows finish later yet failed to override virtual method _finishLaterFunction.";},isCurrentStopTheFirstStop:function WP$UI$SubwayWorkflowController$isCurrentStopTheFirstStop(){return this._currentStep===0},isCurrentStopTheLastStop:function WP$UI$SubwayWorkflowController$isCurrentStopTheLastStop(){return this._currentStep===this._subwayStopControllers.length-1},isNewStopTheFirstStop:function WP$UI$SubwayWorkflowController$isCurrentStopTheFirstStop(){return this._newStep===0},isNewStopTheLastStop:function WP$UI$SubwayWorkflowController$isCurrentStopTheLastStop(){return this._newStep===this._subwayStopControllers.length-1}},G={_onPropertyChanged:function WP$UI$SubwayStop$SubwayNavigationViewBinder$_onPropertyChanged(u,x){var n="visited",d="past",a="future",t=".trainrail",m=".axcontent",l="title",k=".visualcontent",s="aria-disabled",q="@MYCHART@STEPNAME@",v,w,h,c,f,p,o;$$WP.Strings.setDefaultNamespace(e);$$WP.Strings.addMnemonic(q,u.Name);c=this.getBoundElements(u);f=c.children("a");c.removeClass("past now future");f.safeAttr(r,b).safeAttr(s,b).safeAttr("href","#");var g;if(x.to===j.StatusEnum.Indeterminate){if(c.nextUntil(".future").length>0)u.Status=j.StatusEnum.Completed;else u.Status=j.StatusEnum.Incomplete;g=$$WP.Strings.get("VisitedStep");f.find(k).safeAttr(l,g);f.find(m).text(g)}else if(x.to===j.StatusEnum.Current){p=c.parents(i).find(t);h=c.index();c.nextAll().addClass(a).removeClass(d);c.prevAll().addClass(d).removeClass(a);c.addClass("visited now");if(h>0){o=p.eq(h-1);o.nextAll().addClass(a).removeClass(d);o.prevAll().andSelf().addClass(d).removeClass(a);o.addClass(n)}else p.addClass(a).removeClass(d);g=$$WP.Strings.get("CurrentStep");f.find(k).safeAttr(l,g);f.find(m).text(g);w=this.getBoundModels();w.sort(function(b,a){return b.Index-a.Index});for(v=0;v<h;v++)w[v].Status=j.StatusEnum.Completed}else if(x.to===j.StatusEnum.Unstarted){p=c.parents(i).find(t);h=c.index();c.removeClass(n).addClass(a);if(h>0){o=p.eq(h-1);o.removeClass(n)}g=$$WP.Strings.get("FutureStep");f.safeAttr(r,"-1").safeAttr(s,"true");f.find(k).safeAttr(l,g);f.find(m).text(g)}$$WP.Strings.removeMnemonic(q);$$WP.Strings.clearDefaultNamespace()},_onSyncModelToDOM:function WP$UI$SubwayStop$SubwayNavigationViewBinder$_onSyncModelToDOM(a){this._onPropertyChanged(a,b)},_onDomEvent:function WP$UI$SubwayStop$SubwayNavigationViewBinder$_onDomEvent(a,c,e){var d,b;if(a.Status===j.StatusEnum.Completed||a.Status===j.StatusEnum.Incomplete){b=c.prevAll().length;d=c.parents(i).triggerHandler(y,[b]);d&&a.setProperty("Status",j.StatusEnum.Current)}e.preventDefault()}};F.prototype=H;E.prototype=G;$$WP.UI=$$WP.UI||{};$$WP.UI.SubwayWorkflowController=F;F.extend($$WP.Controllers.Controller,"WP$UI$SubwayWorkflowController");E.extend($$WP.Common.ViewBinder,"WP$UI$SubwayStop$SubwayNavigationViewBinder")})();$$WP.Debug.UnitTest=$$WP.Debug.UnitTest||{};$$WP.Debug.UnitTest.tests=$$WP.Debug.UnitTest.tests||[];$$WP.Debug.UnitTest.tests.push(function UnitTests$SubwayWorkflowController(){var a;a=$$WP.Debug.UnitTest.assert})