/*! Copyright Epic Systems Corporation 2016 */
$$WPUtil.guaranteeExistence($$WP,"Visits.PatientVisitGuide");$$WP.Visits.PatientVisitGuide=function PatientVisitGuideComponent(){};$$WP.Visits.PatientVisitGuide.prototype={_status:{COMPELTE:1,INPROGRESS:2,INVALID:3,FAILED:4},MAXNUMBEROFPOLLING:30,MAXNUMBERTOSHOWSECONDMESSAGE:15,INTERVAL:1e3,_numberOfTrying:0,_showLightbox:false,_fileKey:"",_isPolling:false,_$pvgLightboxContent:null,_downloadFileName:"",generateFile:function generateFile(){var a=this;!a._isPolling&&$.proxy($.ajax({type:"POST",url:makeLink("Visits/PatientVisitGuide/GeneratePatientVisitGuide"),dataType:"json",success:$.proxy(function(b){var a=this;a._fileKey=b.FileKey;a._downloadFileName=b.DownloadFileName;if(b.Status===a._status.COMPELTE)a._downloadPVGFile();else if(b.Status===a._status.INPROGRESS){a._showPVGProgressLightbox();a._isPolling=true;a._numberOfTrying++;a._pollFileStatus()}else a._showErrorInLightBox()},a),error:$.proxy(function(){this._showErrorInLightBox()},a)}),a)},_showPVGProgressLightbox:function _showPVGProgressLightbox(){var a=this,b;if(a._$pvgLightboxContent===null)a._$pvgLightboxContent=$afe.renderTemplate($$WP.Templates.Visits.PVGLightboxContent);showLightBox(a._$pvgLightboxContent.html());b=$afe.select("#lightbox_overlay");b.off().on("click",$.proxy(a._resetController,a));a._showLightbox=true},_downloadPVGFile:function _downloadPVGFile(){window.location=makeLink("Visits/PatientVisitGuide/DownloadPatientVisitGuide?fileKey="+encodeURIComponent(this._fileKey)+"&downloadFileName="+encodeURIComponent(this._downloadFileName));this._resetController()},_pollFileStatus:function _pollFileStatus(){var a=this;a._isPolling&&$.proxy($.ajax({type:"POST",url:makeLink("Visits/PatientVisitGuide/CheckPVGFileStatus"),data:{fileKey:a._fileKey},dataType:"json",success:$.proxy(function(e){var b="hidden",a=this,d,c;if(e.Status===a._status.COMPELTE)a._downloadPVGFile();else if(e.Status===a._status.INPROGRESS)if(a._numberOfTrying<=a.MAXNUMBEROFPOLLING){a._numberOfTrying++;if(a._numberOfTrying===a.MAXNUMBERTOSHOWSECONDMESSAGE){d=$afe.select(".pvgmsg");c=$afe.select(".pvgwaitingmsg");!d.hasClass(b)&&d.addClass(b);c.hasClass(b)&&c.removeClass(b)}setTimeout($.proxy(a._pollFileStatus,a),a.INTERVAL)}else a._showErrorInLightBox();else a._showErrorInLightBox()},a),error:$.proxy(function(){this._showErrorInLightBox()},a)}),a)},_showErrorInLightBox:function _showErrorInLightBox(){var b,a;this._resetController();$$WP.Strings.setDefaultNamespace("Visits");a={button:$$WP.Strings.get("ErrorClose"),title:$$WP.Strings.get("ErrorTitle"),content:$$WP.Strings.get("PVGErrorMessage")};b=[new $$WPComp.ComplexObjects.Button(a.button,null,"cancelworkflow","continue")];$$WPUtil.quickMessageBox(a.content,a.title,b);$$WP.Strings.clearDefaultNamespace("Visits")},_resetController:function _resetController(){var b="hidden",a=this,d,c;a._showLightbox&&hideLightbox();d=$afe.select(".pvgmsg");c=$afe.select(".pvgwaitingmsg");d.hasClass(b)&&d.removeClass(b);!c.hasClass(b)&&c.addClass(b);a._isPolling=false;a._fileKey="";a._numberOfTrying=0;a._showLightbox=false;a._$pvgLightboxContent=null}}